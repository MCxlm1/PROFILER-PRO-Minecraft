<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROFILER PRO - Purple Unified Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6750A4; --on-primary: #FFFFFF;
            --primary-container: #EADDFF; --on-primary-container: #21005D;
            --surface: #FEF7FF; --on-surface: #1D1B20;
            --surface-variant: #E7E0EB; --outline-variant: #CAC4D0; 
            --sec-container: #E8DEF8; --scrim: rgba(0, 0, 0, 0.4);
        }
        [data-theme='dark'] {
            --primary: #D0BCFF; --on-primary: #381E72;
            --primary-container: #4F378B; --on-primary-container: #EADDFF;
            --surface: #141218; --on-surface: #E6E1E5;
            --surface-variant: #49454F; --outline-variant: #49454F; --sec-container: #332D41; 
        }

        body { font-family: 'Inter', system-ui, sans-serif; background: var(--surface); color: var(--on-surface); margin: 0; padding-bottom: 120px; transition: 0.3s; overflow-y: scroll; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

        /* 全屏拖拽蒙版 */
        #drop-zone { position: fixed; inset: 0; background: rgba(103, 80, 164, 0.1); backdrop-filter: blur(15px); z-index: 9999; display: none; align-items: center; justify-content: center; border: 4px dashed var(--primary); margin: 20px; border-radius: 40px; pointer-events: none; }
        #drop-zone.active { display: flex; }

        /* 模态框修正 */
        .modal-scrim { position: fixed; inset: 0; background: var(--scrim); backdrop-filter: blur(8px); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--surface); width: 90%; max-width: 650px; border-radius: 32px; padding: 32px; box-shadow: 0 24px 48px rgba(0,0,0,0.3); box-sizing: border-box; }
        #json-input { width: 100%; height: 320px; border-radius: 20px; background: var(--surface-variant); border: 2px solid transparent; padding: 20px; font-family: 'Fira Code', monospace; font-size: 14px; color: inherit; outline: none; resize: none; box-sizing: border-box; transition: 0.2s; }
        #json-input:focus { border-color: var(--primary); background: var(--surface); }

        /* 看板 */
        .metrics-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--sec-container); border-radius: 32px; padding: 28px; position: relative; overflow: hidden; height: 130px; display: flex; flex-direction: column; justify-content: space-between; }
        .stat-card.primary-theme { background: var(--primary); color: var(--on-primary); }
        .stat-card .val { font-size: 48px; font-weight: 950; letter-spacing: -2.5px; line-height: 1; }

        /* 函数卡片与紫色统一设计 */
        .func-card { background: var(--surface); border-radius: 32px; padding: 24px; border: 1px solid var(--outline-variant); margin-bottom: 16px; cursor: pointer; transition: 0.3s; position: relative; }
        .func-card.selected-active { border: 2.5px solid var(--primary); box-shadow: 0 8px 32px rgba(103, 80, 164, 0.15); }
        
        /* 紫色容器样式：函数名与指标块同步 */
        .func-chip { background: var(--primary-container); color: var(--on-primary-container); padding: 6px 16px; border-radius: 14px; font-size: 15px; font-weight: 900; display: inline-block; border: 1.5px solid var(--primary); }
        .file-meta { opacity: 0.6; font-size: 13px; font-weight: 700; margin-left: 10px; }

        .card-metrics { display: flex; gap: 12px; margin-top: 20px; }
        /* 核心修改：指标块改为紫色容器 */
        .m-block { background: var(--primary-container); color: var(--on-primary-container); padding: 12px 16px; border-radius: 20px; flex: 1; border: 1px solid rgba(103, 80, 164, 0.2); }
        .m-block label { display: block; font-size: 10px; font-weight: 800; opacity: 0.7; text-transform: uppercase; margin-bottom: 2px; }
        .m-block span { font-size: 17px; font-weight: 950; }

        /* 子项列表 */
        .sub-entry { display: flex; align-items: center; padding: 18px; background: var(--surface); border-radius: 24px; margin-top: 12px; position: relative; overflow: hidden; border: 1px solid var(--outline-variant); transition: 0.2s; }
        .sub-entry.active { border: 2.5px solid var(--primary); background: var(--primary-container); }
        .sub-icon { width: 44px; height: 44px; background: var(--primary); color: var(--on-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0; }
        .sub-info { flex: 1; z-index: 1; }
        .sub-progress-bg { position: absolute; bottom: 0; left: 0; height: 5px; background: var(--outline-variant); width: 100%; opacity: 0.15; }
        .sub-progress-fill { height: 100%; background: var(--primary); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        .btn-group { display: flex; background: var(--surface-variant); padding: 6px; border-radius: 32px; gap: 4px; }
        .v-tab, .sort-pill { padding: 12px 28px; border: none; background: transparent; font-weight: 800; border-radius: 28px; cursor: pointer; transition: 0.3s; color: inherit; }
        .active-btn { background: var(--primary) !important; color: var(--on-primary) !important; }
        
        .fab-group { position: fixed; right: 32px; bottom: 32px; display: flex; flex-direction: column-reverse; gap: 16px; z-index: 1000; }
        .fab-btn { width: 68px; height: 68px; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 26px; cursor: pointer; border: none; box-shadow: 0 12px 40px rgba(0,0,0,0.2); transition: 0.3s; }
        
        .expand-wrapper { display: grid; grid-template-rows: 0fr; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .expanded .expand-wrapper { grid-template-rows: 1fr; }
        .expand-inner { overflow: hidden; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="drop-zone"><h1>释放 CPU Profile</h1></div>

<div class="modal-scrim" id="manual-modal" onclick="if(event.target===this)closeModal()">
    <div class="modal-content">
        <h2 style="margin:0 0 20px 0; font-weight:950; color:var(--primary);">手动输入数据</h2>
        <textarea id="json-input" placeholder="请在此粘贴 CPU Profile JSON 内容..."></textarea>
        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:28px;">
            <button onclick="closeModal()" style="background:none; border:none; color:var(--primary); font-weight:900; cursor:pointer; padding:12px 24px;">取消</button>
            <button onclick="handleManualInput()" style="background:var(--primary); color:var(--on-primary); border:none; padding:12px 36px; border-radius:24px; font-weight:950; cursor:pointer;">解析</button>
        </div>
    </div>
</div>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 48px 0;">
        <div style="font-weight: 950; font-size: 36px; color: var(--primary); letter-spacing: -2.5px;">PROFILER PRO</div>
        <button onclick="toggleTheme()" class="fab-btn" style="width:56px; height:56px; border-radius:28px; box-shadow:none; background:var(--surface-variant);"><i class="fas fa-circle-half-stroke"></i></button>
    </header>

    <div class="metrics-bar">
        <div class="stat-card">
            <div id="p-loader" style="position:absolute; inset:0; background:var(--primary); color:white; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:20;">
                <div style="width:30px; height:30px; border:4px solid rgba(255,255,255,0.2); border-top-color:white; border-radius:50%; animation:spin 0.8s linear infinite;"></div>
                <div style="font-weight:900; margin-top:12px;">正在计算轨迹...</div>
            </div>
            <label style="font-weight:800; opacity:0.7;">函数总运行次数</label>
            <div class="val" id="v-samples">0</div>
        </div>
        <div class="stat-card primary-theme">
            <label style="font-weight:800; opacity:0.8;">累计执行时长</label>
            <div><span class="val" id="v-time">0.0</span><span class="unit" style="opacity:0.6; font-size:18px; font-weight:700; margin-left:6px;">ms</span></div>
        </div>
    </div>

    <div class="chart-box" style="height:400px; margin-bottom:40px; background:var(--surface); border-radius:40px; padding:28px; border:1px solid var(--outline-variant);"><canvas id="mainChart"></canvas></div>

    <div class="nav-section" style="display:flex; justify-content:space-between; margin-bottom:32px;">
        <div class="btn-group"><button class="v-tab active-btn" id="tab-raw" onclick="switchView('raw')">原始位置</button><button class="v-tab" id="tab-logical" onclick="switchView('logical')">逻辑聚合</button></div>
        <div class="btn-group"><button class="sort-pill active-btn" id="s-total" onclick="setSort('total')">总耗时</button><button class="sort-pill" id="s-h" onclick="setSort('h')">次数</button><button class="sort-pill" id="s-avg" onclick="setSort('avg')">平均</button></div>
    </div>

    <div id="list-container"></div>
</div>

<div class="fab-group">
    <button class="fab-btn" style="background:var(--primary-container); color:var(--on-primary-container);" onclick="toggleFab()"><i class="fas fa-plus"></i></button>
    <button class="fab-btn f-sub" style="background:var(--surface); color:var(--primary); transform:scale(0); opacity:0; visibility:hidden;" onclick="document.getElementById('fileInput').click()"><i class="fas fa-file-upload"></i></button>
    <button class="fab-btn f-sub" style="background:var(--surface); color:var(--primary); transform:scale(0); opacity:0; visibility:hidden;" onclick="openModal()"><i class="fas fa-keyboard"></i></button>
</div>

<input type="file" id="fileInput" hidden accept=".cpuprofile,.json" onchange="handleFile(this.files[0])">

<script>
    const workerBlob = new Blob([`
        self.onmessage = function(e) {
            const { nodes, samples, timeDeltas } = e.data;
            const nodeMap = new Map(nodes.map(n => [n.id, n]));
            const stats = {}; let currentTime = 0;
            const timeline = samples.map((id, i) => {
                currentTime += (timeDeltas[i] || 0);
                if(!stats[id]) stats[id] = { h: 0, t: 0 };
                stats[id].h++; stats[id].t += (timeDeltas[i] || 0);
                return { id, ts: currentTime / 1000000 };
            });
            const funcs = Object.keys(stats).map(id => {
                const f = nodeMap.get(parseInt(id)).callFrame;
                const fileName = f.url ? f.url.split('/').pop() : 'unknown';
                const isAnon = !f.functionName || f.functionName === "<anonymous>" || f.functionName === "";
                return {
                    id: parseInt(id), name: isAnon ? "匿名函数" : f.functionName, isAnon,
                    fileInfo: fileName + ':' + (f.lineNumber || 0),
                    h: stats[id].h, total: stats[id].t / 1000, avg: (stats[id].t / 1000) / stats[id].h
                };
            });
            self.postMessage({funcs, timeline, samplesCount: samples.length, totalTime: currentTime/1000});
        };
    `], {type: 'application/javascript'});

    const worker = new Worker(URL.createObjectURL(workerBlob));
    let allFuncs = [], logicalFuncs = [], timelineData = [], selectedIds = new Set(), chartObj = null, currentView = 'raw', sortKey = 'total';

    worker.onmessage = e => {
        document.getElementById('p-loader').style.display = 'none';
        allFuncs = e.data.funcs; timelineData = e.data.timeline;
        const lMap = {};
        allFuncs.forEach(f => {
            const key = f.isAnon ? "匿名函数" + f.fileInfo : f.name;
            if(!lMap[key]) lMap[key] = { ...f, children: [], id: 'l-'+key, total:0, h:0 };
            lMap[key].total += f.total; lMap[key].h += f.h; lMap[key].children.push(f);
        });
        logicalFuncs = Object.values(lMap).map(m => ({ ...m, avg: m.total/m.h }));
        document.getElementById('v-samples').innerText = e.data.samplesCount.toLocaleString();
        document.getElementById('v-time').innerText = e.data.totalTime.toFixed(1);
        selectedIds = new Set(allFuncs.sort((a,b)=>b.total-a.total).slice(0,3).map(f=>f.id));
        renderUI(); initChart(e.data.totalTime / 1000);
    };

    function renderUI() {
        const container = document.getElementById('list-container');
        const data = currentView === 'raw' ? allFuncs : logicalFuncs;
        const sorted = [...data].sort((a,b) => b[sortKey] - a[sortKey]);
        
        container.innerHTML = sorted.map(d => {
            const isCardActive = (currentView === 'raw' && selectedIds.has(d.id));
            const nameHtml = `<div><span class="func-chip">${d.name}</span><span class="file-meta">${d.fileInfo}</span></div>`;
            const metricsHtml = `<div class="card-metrics"><div class="m-block"><label>总耗时</label><span>${d.total.toFixed(1)}ms</span></div><div class="m-block"><label>次数</label><span>${d.h}</span></div><div class="m-block"><label>平均</label><span>${d.avg.toFixed(3)}ms</span></div></div>`;

            if(currentView === 'raw') {
                return `<div class="func-card ${isCardActive?'selected-active':''}" onclick="toggleF(${d.id})">${nameHtml}${metricsHtml}</div>`;
            } else {
                return `<div class="func-card" onclick="handleCardClick(event, this)">
                    <div style="display:flex; justify-content:space-between; align-items:center;">${nameHtml}<i class="fas fa-chevron-down expand-icon" style="transition:0.4s; color:var(--primary);"></i></div>
                    ${metricsHtml}
                    <div class="expand-wrapper"><div class="expand-inner"><div style="padding-top:16px;">
                        ${d.children.map(c => {
                            const pct = (c.total/d.total*100).toFixed(1);
                            return `<div class="sub-entry ${selectedIds.has(c.id)?'active':''}" onclick="toggleSubItem(event, ${c.id})">
                                <div class="sub-icon"><i class="fas fa-microchip"></i></div>
                                <div class="sub-info"><div style="font-family:monospace; font-weight:700;">${c.fileInfo}</div><div class="sub-meta">占比 ${pct}% · 时长 ${c.total.toFixed(1)}ms · 次数 ${c.h} · 平均 ${c.avg.toFixed(3)}ms</div></div>
                                <div class="sub-progress-bg"><div class="sub-progress-fill" style="width:${pct}%;"></div></div>
                            </div>`;
                        }).join('')}
                    </div></div></div></div>`;
            }
        }).join('');
    }

    function handleManualInput() { try { const data = JSON.parse(document.getElementById('json-input').value); document.getElementById('p-loader').style.display='flex'; worker.postMessage(data); closeModal(); } catch(e) { alert("JSON 格式无效"); } }
    function openModal() { document.getElementById('manual-modal').style.display='flex'; toggleFab(); }
    function closeModal() { document.getElementById('manual-modal').style.display='none'; }
    function toggleFab() { const subs=document.querySelectorAll('.f-sub'); const open=subs[0].style.transform==='scale(1)'; subs.forEach(s=>{ s.style.transform=open?'scale(0)':'scale(1)'; s.style.opacity=open?0:1; s.style.visibility=open?'hidden':'visible'; }); }
    function handleFile(f) { if(!f) return; const r=new FileReader(); r.onload=e=>{ document.getElementById('p-loader').style.display='flex'; worker.postMessage(JSON.parse(e.target.result)); }; r.readAsText(f); }
    function handleCardClick(e, el) { if (e.target.closest('.sub-entry')) return; el.classList.toggle('expanded'); }
    function toggleSubItem(e, id) { e.stopPropagation(); if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderUI(); updateChart(); }
    function toggleF(id) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderUI(); updateChart(); }
    function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'); }

    const dz = document.getElementById('drop-zone');
    window.addEventListener('dragenter', e => { e.preventDefault(); dz.classList.add('active'); });
    window.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('active'); });
    window.addEventListener('dragleave', e => { if (!e.relatedTarget) dz.classList.remove('active'); });
    window.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('active'); handleFile(e.dataTransfer.files[0]); });

    function initChart(totalSeconds) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, {
            type: 'line', data: { labels: Array.from({length:60}, (_,i) => ((totalSeconds/59)*i).toFixed(3) + "s"), datasets: [] },
            options: { 
                responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
                plugins:{ legend:{display:false}, tooltip:{enabled:true, backgroundColor:'rgba(29,27,32,0.95)', padding:16, cornerRadius:16, callbacks: { title: (c) => `时间点: ${c[0].label}`, label: (c) => ` ${c.dataset.label}: ${c.parsed.y} 次` }} },
                scales:{ x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)'}} }
            }
        });
        updateChart();
    }
    function updateChart() {
        const top = allFuncs.filter(f=>selectedIds.has(f.id)).slice(0,10);
        const step = Math.ceil(timelineData.length / 60);
        chartObj.data.datasets = top.map((f,i) => ({
            label: f.name,
            data: Array.from({length:60}, (_,j) => {
                const chunk = timelineData.slice(j*step, (j+1)*step);
                return chunk.filter(p => p.id === f.id).length;
            }),
            borderColor: ['#6750A4','#00BFA5','#FF5252','#FFAB40','#448AFF'][i%5],
            tension:0.4, borderWidth:3, pointRadius:0, hoverPointRadius:6
        }));
        chartObj.update('none');
    }
    function switchView(v) { currentView=v; renderUI(); document.querySelectorAll('.v-tab').forEach(b=>b.classList.toggle('active-btn', b.id==='tab-'+v)); }
    function setSort(k) { sortKey=k; renderUI(); document.querySelectorAll('.sort-pill').forEach(b=>b.classList.toggle('active-btn', b.id==='s-'+k)); }
</script>
</body>
</html>
